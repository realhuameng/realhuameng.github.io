<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Hua Meng,1263313190@qq.com"><title>手搓Spring-05资源加载器解析文件注册对象 · Realhuameng</title><meta name="description" content="设计与实现资源加载器，从Spring.xml解析和注册Bean对象目前实现的spring框架可以通过单元测试手动操作Bean对象的定义、注册和属性填充
可以将创建过程写入配置文件中来简化操作，通过spring配置文件的方式将Bean对象实例化
功能设计根据需求背景，我们需要在现有的Spring框架雏"><meta name="keywords" content="C++,Linux,Java,Go"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Realhuameng</a></h3><div class="description"><p>Fake it till you make it.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="http://github.com/realhuameng"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a target="_blank" rel="noopener" href="https://www.caicai.me"> CaiCai </a><span>&</span><a target="_blank" rel="noopener" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">Sobre</a></li><li><a href="/archives">Archivo</a></li><li><a href="/links">Enlaces</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/favicon.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>手搓Spring-05资源加载器解析文件注册对象</a></h3></div><div class="post-content"><h1 id="设计与实现资源加载器，从Spring-xml解析和注册Bean对象"><a href="#设计与实现资源加载器，从Spring-xml解析和注册Bean对象" class="headerlink" title="设计与实现资源加载器，从Spring.xml解析和注册Bean对象"></a>设计与实现资源加载器，从Spring.xml解析和注册Bean对象</h1><p>目前实现的spring框架可以通过单元测试手动操作Bean对象的定义、注册和属性填充</p>
<p>可以将创建过程写入配置文件中来简化操作，通过spring配置文件的方式将Bean对象实例化</p>
<h2 id="功能设计"><a href="#功能设计" class="headerlink" title="功能设计"></a>功能设计</h2><p>根据需求背景，我们需要在现有的Spring框架雏形中添加一个资源解析器，也就是能读取classpath、本地文件和云文件的配置内容。</p>
<p>在读取配置文件信息后，接下来就是对配置文件中的Bean描述信息解析后进行注册操作，把Bean对象注册到Spring容器中</p>
<p>资源加载器属于相对独立的部分，它位于Spring框架核心包下的IO实现内容，主要用于处理Class、本地和云环境中的文件信息</p>
<p>当资源可以加载后，接下来就是解析和注册Bean到Spring中的操作，这部分功能需要和DefaultListableBeanFactory核心类结合起来</p>
<p>另外还要定义出Bean定义的读取接口BeanDefinitionReader以及做好对应的实现类，在实现类中完成对Bean对象的解析和注册</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="工程结构"><a href="#工程结构" class="headerlink" title="工程结构"></a>工程结构</h3><p>Spring Bean容器资源加载和使用类关系</p>
<p>为了能把Bean的定义、注册和初始化交给Spring.xml配置化处理，需要实现两大块内容：资源加载器和xml资源处理类，实现过程主要以对接口Resource、ResourceLoader的实现为主</p>
<p>BeanDefinitionReader接口是对资源的具体使用，将配置信息注册到Spring容器中去</p>
<p>在Resource资源加载器中包括ClassPath、系统文件、云配置文件，这三部分与Spring源码中的设计与实现保持一致，最终在DefaultResourceLoader中做具体的调用</p>
<p>接口BeanDefinition、抽象类AbstractBeanDefinitionReader、实现类XmlBeanDefinitionReader</p>
<p>主要功能是处理资源读取后的注册Bean容器的操作</p>
<p>接口负责定义，抽象类处理非接口功能外的注册Bean组件填充，最终类只关心具体的业务实现</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20130304.png"></p>
<p>此外，本部分根据Spring源码，完善了相应接口的集成和实现的关系</p>
<p>HierarchicalBeanFactory，在Spring源码中它提供了可以获取父类BeanFactory的方法，属于一种扩展工程的层次子接口</p>
<p>AutowireCapableBeanFactory，是一个自动化处理Bean工厂配置的接口</p>
<p>ConfigurableBeanFactory，可获取 BeanPostProcessor、BeanClassLoader等的一个配置化接口</p>
<p>ConfigurableListableBeanFactory，提供分析和修改Bean以及预先实例化的操作接口</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20132058.png"></p>
<h3 id="定义工具类"><a href="#定义工具类" class="headerlink" title="定义工具类"></a>定义工具类</h3><p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20133605.png"></p>
<h3 id="资源加载接口定义和实现"><a href="#资源加载接口定义和实现" class="headerlink" title="资源加载接口定义和实现"></a>资源加载接口定义和实现</h3><p>在Spring框架下创建core.io核心包，主要用于处理资源加载流</p>
<p>定义Resource接口，提供获取流的方法，再分别实现三种不同的流文件操作</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20132548.png"></p>
<p>ClassPath：</p>
<p>通过ClassLoader读取ClassPath下的文件信息</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20133802.png"></p>
<p>FileSystem：</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20134138.png"></p>
<p>Url：</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20134452.png"></p>
<h3 id="包装资源加载器"><a href="#包装资源加载器" class="headerlink" title="包装资源加载器"></a>包装资源加载器</h3><p>定义接口：</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20135700.png"></p>
<p>实现接口：</p>
<p>将三种类型的资源进行包装，判断是否为ClassPath、URL以及文件</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20140140.png"></p>
<h3 id="Bean定义读取接口"><a href="#Bean定义读取接口" class="headerlink" title="Bean定义读取接口"></a>Bean定义读取接口</h3><p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20140535.png"></p>
<h3 id="Bean定义抽象类实现"><a href="#Bean定义抽象类实现" class="headerlink" title="Bean定义抽象类实现"></a>Bean定义抽象类实现</h3><p>实现BeanDefinitionReader接口的前两个方法，并提供构造函数，让外部的调用使用方把Bean定义注入类</p>
<p><img src="https://my-blog-realhuameng.oss-cn-hangzhou.aliyuncs.com/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-27%20141247.png"></p>
<h3 id="解析XML处理Bean注册"><a href="#解析XML处理Bean注册" class="headerlink" title="解析XML处理Bean注册"></a>解析XML处理Bean注册</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XmlBeanDefinitionReader</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBeanDefinitionReader</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">public</span> <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token keyword">super</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>      <span class="token keyword">public</span> <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token keyword">super</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>      <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>             <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                 <span class="token function">doLoadBeanDefinition</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>         <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeansException</span><span class="token punctuation">(</span><span class="token string">"IOException parsing XML document from"</span> <span class="token operator">+</span> resource<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span>      <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span>      <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">String</span> location<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>         <span class="token class-name">ResourceLoader</span> resourceLoader <span class="token operator">=</span> <span class="token function">getResourceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">Resource</span> resource <span class="token operator">=</span> resourceLoader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>      <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doLoadBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">&#123;</span>         <span class="token class-name">Document</span> doc <span class="token operator">=</span> <span class="token class-name">XmlUtil</span><span class="token punctuation">.</span><span class="token function">readXML</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">Element</span> root <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getDocumentElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">NodeList</span> childNodes <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>childNodes<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token comment">//判断元素             if(!(childNodes.item(i) instanceof Element)) continue;             //判断对象             if(!"bean".equals(childNodes.item(i).getNodeName())) continue;              //解析标签             Element bean = (Element)childNodes.item(i);             String id = bean.getAttribute("id");             String name = bean.getAttribute("name");             String className = bean.getAttribute("class");              //获取class             Class&lt;?> clazz = Class.forName(className);             String beanName = StrUtil.isNotEmpty(id) ? id : name;             if(StrUtil.isEmpty(beanName))&#123;                 beanName = StrUtil.lowerFirst(clazz.getSimpleName());             &#125;              BeanDefinition beanDefinition = new BeanDefinition(clazz);              for(int j=0;j&lt;bean.getChildNodes().getLength();j++)&#123;                 if(!(bean.getChildNodes().item(j) instanceof Element)) continue;                 if(!"property".equals(bean.getChildNodes().item(j).getNodeName())) continue;                  Element property = (Element)bean.getChildNodes().item(j);                 String attrName = property.getAttribute("name");                 String attrValue = property.getAttribute("value");                 String attrRef = property.getAttribute("ref");                  Object value = StrUtil.isNotEmpty(attrRef) ? new BeanReference(attrRef) : attrValue;                  PropertyValue propertyValue = new PropertyValue(attrName, value);                 beanDefinition.getPropertyValues().addPropertyValue(propertyValue);              &#125;              if(getRegistry().containBeanDefinition(beanName))&#123;                 throw new BeansException("Duplicate beanName[" + beanName + "] is not allowed");             &#125;              getRegistry().registerBeanDefinition(beanName, beanDefinition);           &#125;      &#125; &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-27</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://realhuameng.github.io/2024/01/27/shou-cuo-spring-05-zi-yuan-jia-zai-qi-jie-xi-wen-jian-zhu-ce-dui-xiang/,Realhuameng,手搓Spring-05资源加载器解析文件注册对象,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/01/28/shou-cuo-spring-06-shi-xian-ying-yong-shang-xia-wen-zi-dong-shi-bie-zi-yuan-jia-zai-kuo-zhan-ji-zhi/" title="手搓Spring-06实现应用上下文、自动识别、资源加载、扩展机制">Post anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/01/26/shou-cuo-spring-04-wei-bean-dui-xiang-zhu-ru-shu-xing-he-yi-lai-bean-de-gong-neng-shi-xian/" title="手搓Spring-04为Bean对象注入属性和依赖Bean的功能实现">Post siguiente</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>